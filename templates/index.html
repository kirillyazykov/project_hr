<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Сотрудники</title>
    <style>
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .success { color: green; }
        .error { color: red; }
        .pagination { margin: 20px 0; text-align: center; }
        .pagination a { margin: 0 5px; padding: 5px 10px; text-decoration: none; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <h1>Список сотрудников</h1>

    <!-- Сообщения -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Поиск -->
    <form method="GET" action="/">
        <input type="text" name="search" value="{{ search }}" placeholder="Поиск по ФИО">
        <button type="submit">Найти</button>
    </form>

    <!-- Сортировка -->
    <p>
        Сортировать по:
        <a href="?sort=id&order=asc{% if search %}&search={{ search }}{% endif %}">ID ↑</a> |
        <a href="?sort=id&order=desc{% if search %}&search={{ search }}{% endif %}">ID ↓</a> |
        <a href="?sort=name&order=asc{% if search %}&search={{ search }}{% endif %}">ФИО ↑</a> |
        <a href="?sort=name&order=desc{% if search %}&search={{ search }}{% endif %}">ФИО ↓</a> |
        <a href="?sort=position&order=asc{% if search %}&search={{ search }}{% endif %}">Должность ↑</a> |
        <a href="?sort=position&order=desc{% if search %}&search={{ search }}{% endif %}">Должность ↓</a> |
        <a href="?sort=salary&order=asc{% if search %}&search={{ search }}{% endif %}">Зарплата ↑</a> |
        <a href="?sort=salary&order=desc{% if search %}&search={{ search }}{% endif %}">Зарплата ↓</a>
    </p>

    <!-- Таблица -->
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>ФИО</th>
                <th>Должность</th>
                <th>Дата приема</th>
                <th>Зарплата</th>
                <th>Начальник</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for emp in employees.items %}
            <tr>
                <td>{{ emp.id }}</td>
                <td>{{ emp.full_name }}</td>
                <td>{{ emp.position }}</td>
                <td>{{ emp.hire_date }}</td>
                <td>{{ emp.salary }}</td>
                <td>
                    {% if emp.manager_id %}
                        {% set manager = manager_dict.get(emp.manager_id) %}
                        {% if manager %}
                            {{ manager.full_name }}
                        {% else %}
                            Нет
                        {% endif %}
                    {% else %}
                        Нет
                    {% endif %}
                </td>
                <td>
                    <form method="POST" action="/update_manager/{{ emp.id }}">
                        <select name="manager_id">
                            <option value="">Без начальника</option>
                            {% for manager in all_managers %}
                                {% if manager.id != emp.id %}
                                    <option value="{{ manager.id }}"
                                        {% if manager.id == emp.manager_id %}selected{% endif %}>
                                        {{ manager.full_name }} ({{ manager.position }})
                                    </option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        <button type="submit">Обновить</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Пагинация -->
    <div class="pagination">
        {% if employees.has_prev %}
            <a href="{{ url_for('index', page=employees.prev_num, sort=request.args.get('sort'), order=request.args.get('order'), search=search) }}">Предыдущая</a>
        {% endif %}
        
        Страница {{ employees.page }} из {{ employees.pages }}
        
        {% if employees.has_next %}
            <a href="{{ url_for('index', page=employees.next_num, sort=request.args.get('sort'), order=request.args.get('order'), search=search) }}">Следующая</a>
        {% endif %}
    </div>

    <!-- Выгрузка -->
    <p>
        <a href="/export_db">Выгрузить базу данных</a> |
        <a href="/export_hierarchy">Выгрузить иерархию</a> |
        <a href="/check_hierarchy">Проверить иерархию</a>
    </p>
    <p>
        <a href="/growth_report">Отчёт о росте сотрудников</a> |
        <a href="/salary_fund_report">Фонд оплаты труда</a>
    </p>
</body>
</html>